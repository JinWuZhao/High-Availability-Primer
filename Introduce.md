# 可用性

## 定义
可用性(Availability)就是一个系统处在可工作状态的时间的比例。

## 公式
```
MTBF: Mean time between Failures. 平均故障间隔
MTTR: Mean time to recover. 平均修复时间
Availability = MTBF / (MTBF + MDT)
```

## Service Level Agreement服务水平协议(SLA)
服务提供商与受服务用户之间具体达成了承诺的服务指标——质量、可用性，责任。

## SLA举例
[亚马逊EC2](https://aws.amazon.com/cn/ec2/sla/)  
[阿里云ECS](https://help.aliyun.com/knowledge_detail/40683.html)  
[Azure虚拟机](https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/v1_6/)  

# 服务失效

## 定义故障
- 打不开网站页面
- 无法登陆账户
- 无法查看商品列表
- 付不成功
- 无法评价商品
- 无法弹出广告
- 运营平台数据异常
- 服务短暂崩溃
- 日志出现Error记录

## 导致故障的原因
### 系统故障
- CPU、内存、电源、网络、外围设备等
- 操作系统
- 数据库
- 中间件
- 应用程序
### 数据和资源错误
- 操作失误
- 蓄意破坏
- 磁盘故障
- 数据损坏
### 服务停运
- 自然灾害
- 停电
- 其它不可抗力

## 非故障性失效
- 维护
- 升级
- 其它常规操作(备份数据库、修改配置等)

# 发现故障的阶段

## 故障前
系统有潜在缺陷，尚未被触发。
如：空指针、未捕获的异常、没有检查外部输入合法性、逻辑错误、性能问题、单点故障等等。

## 故障中
系统运行不正常，但没有完全影响到系统运行，外部用户还没有完全感知到。
如：机器过载、服务崩溃、某个接口响应超时、数据不一致等等。

## 故障后
系统外用户已经能够感知到故障。
如：打不开页面、服务无法访问、数据错乱等等。

# 处理方案

## 故障后处理
- 人工排查
- 恢复数据
- 回滚服务
- 修改配置
- 升级机器
- 增加机器

## 故障中处理
- 服务质量监控
    - 是否可访问
    - 响应时长
    - 资源占用
    - 服务崩溃
    - 自动报警

- 快速恢复
    - 自动重启
    - 过载保护
    - 请求隔离
    - 系统降级
    - 主备切换

## 故障前处理
- 提高冗余度
    - N+2个实例
    - 实例间对等、独立
    - 流量控制
    - 数据一致性

- 变更管理
    - 线下测试
    - 灰度发布
    - 回滚支持
    - 兼容设计

- 程序设计
    - 防御式编程
    - let it crash
    - 错误处理
    - 并发模型
    - 编程范式

# 可用性级别

故障发生时。。

1. 服务崩溃导致数据损坏、丢失。
2. 服务崩溃，丢失最近的新数据。
3. 服务崩溃，不丢失数据。
4. 不崩溃，但不提供或只提供很有限的服务，低服务质量。
5. 提供部分或有限的服务，中等服务质量。
6. 故障转移伴随着用户可见的延迟，近乎完整的服务质量。
7. 故障转移延迟很短无法察觉，近乎完整的服务质量。

我们的服务属于哪个级别？-. -